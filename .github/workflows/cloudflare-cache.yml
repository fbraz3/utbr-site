name: Clear Cloudflare Cache

on:
  workflow_dispatch:

jobs:
  clear-cache:
    runs-on: ubuntu-latest
    
    steps:
    - name: Clear Cloudflare cache - Domain 1
      run: |
        echo "üßπ Clearing Cloudflare cache for Domain 1..."
        RESPONSE=$(curl -s -w "%{http_code}" -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.TOKEN_CF_1 }}/purge_cache" \
          -H "Authorization: Bearer ${{ secrets.CF_AUTH_BEARER }}" \
          -H "Content-Type: application/json" \
          --data '{"purge_everything":true}')
        
        HTTP_CODE="${RESPONSE: -3}"
        BODY="${RESPONSE%???}"
        
        if [ "$HTTP_CODE" -eq 200 ]; then
          echo "‚úÖ Domain 1 cache cleared successfully"
          echo "Response: $BODY"
        else
          echo "‚ùå Failed to clear Domain 1 cache (HTTP $HTTP_CODE)"
          echo "Response: $BODY"
          exit 1
        fi

    - name: Clear Cloudflare cache - Domain 2
      run: |
        echo "üßπ Clearing Cloudflare cache for Domain 2..."
        RESPONSE=$(curl -s -w "%{http_code}" -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.TOKEN_CF_2 }}/purge_cache" \
          -H "Authorization: Bearer ${{ secrets.CF_AUTH_BEARER }}" \
          -H "Content-Type: application/json" \
          --data '{"purge_everything":true}')
        
        HTTP_CODE="${RESPONSE: -3}"
        BODY="${RESPONSE%???}"
        
        if [ "$HTTP_CODE" -eq 200 ]; then
          echo "‚úÖ Domain 2 cache cleared successfully"
          echo "Response: $BODY"
        else
          echo "‚ùå Failed to clear Domain 2 cache (HTTP $HTTP_CODE)"
          echo "Response: $BODY"
          exit 1
        fi

    - name: Cache clear summary
      run: |
        echo "üéâ Cloudflare cache clearing completed successfully!"
        echo "üìù Summary:"
        echo "  - Domain 1: Cache cleared"
        echo "  - Domain 2: Cache cleared"
        echo "  - Trigger: Manual via workflow_dispatch"
        echo "  - Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

    - name: Wait for cache propagation
      run: |
        echo "‚è≥ Waiting 1 minute for cache propagation..."
        sleep 60
        echo "‚úÖ Wait completed"

    - name: Warm up cache
      run: |
        echo "üî• Warming up cache for https://utbr.cf..."
        RESPONSE=$(curl -qI https://utbr.cf 2>&1)
        EXIT_CODE=$?
        
        if [ $EXIT_CODE -eq 0 ]; then
          echo "‚úÖ Cache warmed successfully"
          echo "Response headers:"
          echo "$RESPONSE" | head -10
        else
          echo "‚ö†Ô∏è Cache warming failed, but continuing..."
          echo "Error: $RESPONSE"
        fi
        
        echo "üéØ Cache warming completed"
